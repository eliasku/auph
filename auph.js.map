{"version":3,"file":"auph.js","sources":["../module/protocol/interface.js","../module/null/index.js","../module/webaudio/debug.js","../module/webaudio/Mixer.js","../module/webaudio/StreamPlayer.js","../module/webaudio/common.js","../module/webaudio/Voice.js","../module/webaudio/Bus.js","../module/webaudio/Buffer.js","../module/webaudio/index.js","../module/index.js","../module/protocol/static.js"],"sourcesContent":["/**\n * Object Name Identifier Layout: [00tt 0000 | vvvv vvvv | vvvv vvvv | iiii iiii]\n */\nexport var tMask = 0x30000000;\nexport var vMask = 0x00FFFF00;\nexport var vIncr = 0x00000100;\nexport var iMask = 0x000000FF;\nexport var Mixer = 0x00000001;\n// used for integer to float params conversion\nexport var Unit = 1024;\nexport var DefaultBus = 1 /* Sound */ | 268435456 /* Bus */;\n//# sourceMappingURL=interface.js.map","export function init() {\n}\nexport function shutdown() {\n}\nexport function load(filepath, flags) {\n    return 0;\n}\nexport function loadMemory(data, flags) {\n    return 0;\n}\nexport function unload(name) {\n}\nexport function voice(buffer, gain, pan, rate, flags, bus) {\n    return 0;\n}\nexport function stop(name) {\n}\nexport function set(name, param, value) {\n}\nexport function get(name, param) {\n    return 0;\n}\n//# sourceMappingURL=index.js.map","var TAG = \"[AUPH]\";\nexport function log(message) {\n    if (process.env.NODE_ENV !== \"production\") {\n        console.log(TAG, message);\n    }\n}\nexport function warn(message) {\n    console.warn(TAG, message);\n}\nexport function error(message, reason) {\n    console.error(TAG, message, reason);\n}\nexport function measure(ts) {\n    if (process.env.NODE_ENV !== \"production\") {\n        return performance.now() - ts;\n    }\n    else {\n        return 0;\n    }\n}\n//# sourceMappingURL=debug.js.map","import { error, log, warn } from \"./debug\";\nvar ctx = null;\nvar unlockEvents = [\"mousedown\", \"pointerdown\", \"touchstart\"];\nvar unlocked = false;\nexport function getContext() {\n    if (!ctx || ctx.state === \"closed\") {\n        warn(1 /* InvalidState */);\n        return null;\n    }\n    return ctx;\n}\nexport function getAudioContextObject() {\n    return ctx;\n}\nexport function getContextState(ctx) {\n    var state = 0;\n    if (ctx.state !== \"closed\") {\n        state |= 1 /* Active */;\n        if (ctx.state === \"running\") {\n            state |= 2 /* Running */;\n        }\n    }\n    return state;\n}\nexport function audioContextResume(ctx) {\n    log(2 /* DeviceResuming */);\n    ctx.resume().then(function () {\n        log(3 /* DeviceResumed */);\n    }).catch(function (reason) {\n        if (!unlocked) {\n            log(17 /* UserInteractionRequiredToStart */);\n            setupUnlockHandler();\n        }\n        else {\n            error(4 /* DeviceResumeError */, reason);\n        }\n    });\n}\nexport function audioContextPause(ctx) {\n    log(5 /* DevicePausing */);\n    ctx.suspend().then(function () {\n        log(6 /* DevicePaused */);\n    }).catch(function (reason) {\n        error(7 /* DevicePauseError */, reason);\n    });\n}\nfunction unlock() {\n    unlocked = true;\n    var removeEventListener = document.removeEventListener;\n    for (var i = 0; i < unlockEvents.length; ++i) {\n        removeEventListener(unlockEvents[i], unlock);\n    }\n    if (ctx && ctx.state === \"suspended\") {\n        audioContextResume(ctx);\n    }\n}\nfunction setupUnlockHandler() {\n    var addEventListener = document.addEventListener;\n    for (var i = 0; i < unlockEvents.length; ++i) {\n        addEventListener(unlockEvents[i], unlock);\n    }\n}\nfunction newAudioContext(options) {\n    try {\n        var scope = window;\n        var audioContext = scope.AudioContext || scope.webkitAudioContext;\n        //scope.AudioContext = audioContext;\n        return new audioContext({\n            latencyHint: \"interactive\",\n            sampleRate: 22050\n        });\n    }\n    catch (_a) {\n        error(0 /* NotSupported */);\n    }\n    return null;\n}\nexport function initContext() {\n    if (ctx) {\n        warn(13 /* Warning_AlreadyInitialized */);\n        return ctx;\n    }\n    ctx = newAudioContext({\n        latencyHint: \"interactive\",\n        sampleRate: 22050\n    });\n    if (ctx && ctx.state === \"running\") {\n        audioContextPause(ctx);\n    }\n    return ctx;\n}\nexport function closeContext(_notNullCtx) {\n    log(8 /* DeviceClosing */);\n    _notNullCtx.close().then(function () {\n        log(9 /* DeviceClosed */);\n    }).catch(function (reason) {\n        error(10 /* DeviceCloseError */, reason);\n    });\n    ctx = null;\n}\nexport function _setAudioParam(param, value) {\n    if (param.value !== value) {\n        param.value = value;\n    }\n}\n//# sourceMappingURL=Mixer.js.map","import { getContext } from \"./Mixer\";\nimport { error, log } from \"./debug\";\nvar emptyWaveData = \"data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAVFYAAFRWAAABAAgAZGF0YQAAAAA=\";\nvar StreamPlayer = /** @class */ (function () {\n    function StreamPlayer(el, node) {\n        this.el = el;\n        this.node = node;\n    }\n    return StreamPlayer;\n}());\nexport { StreamPlayer };\nexport function StreamPlayer_create(ctx, url) {\n    var el = new Audio(url);\n    el.preload = \"metadata\";\n    el[\"preservesPitch\"] = false;\n    return new StreamPlayer(el, ctx.createMediaElementSource(el));\n}\nexport function StreamPlayer_isFree(player) {\n    return player.el.src === emptyWaveData;\n}\nexport function StreamPlayer_stop(player) {\n    var el = player.el;\n    if (el.src !== emptyWaveData) {\n        el.onended = null;\n        el.pause();\n        el.src = emptyWaveData;\n        el.currentTime = 0;\n        player.node.disconnect();\n    }\n}\nexport function _streamPlayerResume(player) {\n    player.el.play().then(function () {\n        log(\"started stream player\");\n    }).catch(function (reason) {\n        error(\"error on play stream\", reason);\n    });\n}\nvar players = [];\nvar playersMaxCount = 4;\nexport function getNextStreamPlayer(src) {\n    for (var i = 0; i < players.length; ++i) {\n        var player = players[i];\n        if (StreamPlayer_isFree(player)) {\n            player.el.src = src;\n            return player;\n        }\n    }\n    if (players.length < playersMaxCount) {\n        var ctx = getContext();\n        if (ctx) {\n            var mes = StreamPlayer_create(ctx, src);\n            players.push(mes);\n            return mes;\n        }\n    }\n    return null;\n}\nexport function destroyStreamPlayersPool() {\n    for (var i = 0; i < players.length; ++i) {\n        var player = players[i];\n        StreamPlayer_stop(player);\n        player.el.src = \"\";\n    }\n    players.length = 0;\n}\nexport function getStreamPlayersCount() {\n    var count = 0;\n    for (var i = 0; i < players.length; ++i) {\n        if (!StreamPlayer_isFree(players[i])) {\n            ++count;\n        }\n    }\n    return count;\n}\n//# sourceMappingURL=StreamPlayer.js.map","import { iMask, tMask, vIncr, vMask } from \"../protocol/interface\";\nexport function nextHandle(h) {\n    return ((h + vIncr) & vMask) | (h & (tMask | iMask));\n}\n//# sourceMappingURL=common.js.map","import { _streamPlayerResume, StreamPlayer_stop } from \"./StreamPlayer\";\nimport { getContext } from \"./Mixer\";\nimport { iMask, Unit } from \"../protocol/interface\";\nimport { nextHandle } from \"./common\";\nvar VoiceObj = /** @class */ (function () {\n    function VoiceObj(gain, pan, index) {\n        var _this = this;\n        this.gain = gain;\n        this.pan = pan;\n        // handle passport\n        this.h = 0;\n        // Control Flags\n        this.s = 0;\n        this._gain = Unit;\n        this._pan = Unit;\n        this._rate = Unit;\n        this.data = 0;\n        this.bus = 0;\n        this.stream = null;\n        // static buffer playback\n        this._started = false;\n        this.buffer = null;\n        // common nodes\n        this.target = null;\n        this._e = function () {\n            // maybe check is useful\n            //if (this.buffer === e.target || (this.stream && this.stream.el === e.target)) {\n            _voiceStop(_this);\n            //}\n        };\n        this.h = 805306368 /* Voice */ | index;\n    }\n    return VoiceObj;\n}());\nexport { VoiceObj };\nexport function _voiceNew(ctx, index) {\n    var gain = ctx.createGain();\n    var pan = ctx.createStereoPanner();\n    pan.connect(gain);\n    return new VoiceObj(gain, pan, index);\n}\nexport function _voiceChangeDestination(v, target) {\n    if (target !== v.target) {\n        var gain = v.gain;\n        if (v.target) {\n            gain.disconnect(v.target);\n        }\n        v.target = target;\n        if (target) {\n            gain.connect(target);\n        }\n    }\n}\nexport function _voiceResetDestination(v) {\n    if (v.target) {\n        v.gain.disconnect(v.target);\n        v.target = null;\n    }\n}\nexport function _voiceStop(v) {\n    // stop stream\n    if (v.stream) {\n        StreamPlayer_stop(v.stream);\n        v.stream = null;\n    }\n    // stop buffer\n    var buffer = v.buffer;\n    if (buffer) {\n        if ((v.s & 2 /* Running */) !== 0) {\n            buffer.stop();\n        }\n        buffer.disconnect();\n        v.buffer = null;\n    }\n    _voiceResetDestination(v);\n    v.data = 0;\n    v.bus = 0;\n    v.s = 0;\n    v.h = nextHandle(v.h);\n}\nexport function _voiceStartBuffer(v) {\n    var source = v.buffer;\n    if (source && !v._started) {\n        //source.addEventListener(\"ended\", v._e, {once: true});\n        source.onended = v._e;\n        source.loop = (v.s & 4 /* Loop */) !== 0;\n        source.start();\n        v._started = true;\n    }\n}\nexport function _voicePrepareBuffer(v, ctx, audioBuffer) {\n    var source = ctx.createBufferSource();\n    source.buffer = audioBuffer;\n    source.connect(v.pan);\n    v.buffer = source;\n    v._started = false;\n}\nexport function _voiceSetLoop(v, value) {\n    var current = (v.s & 4 /* Loop */) !== 0;\n    if (value !== current) {\n        v.s ^= 4 /* Loop */;\n        if (v.stream) {\n            v.stream.el.loop = value;\n        }\n        else if (v.buffer) {\n            v.buffer.loop = value;\n        }\n    }\n}\nexport function _voiceSetRunning(v, value) {\n    var current = !!(v.s & 2 /* Running */);\n    if (value !== current) {\n        v.s ^= 2 /* Running */;\n        if (v.stream) {\n            if (value) {\n                _streamPlayerResume(v.stream);\n            }\n            else {\n                v.stream.el.pause();\n            }\n        }\n        else if (v.buffer) {\n            v.buffer.playbackRate.value = value ? (v._rate / Unit) : 0.0;\n            if (value) {\n                // restart if play called in pause mode\n                _voiceStartBuffer(v);\n            }\n        }\n    }\n}\nexport function _voiceSetPitch(v, value) {\n    if (v._rate !== value) {\n        v._rate = value;\n        if (v.stream) {\n            v.stream.el.playbackRate = value / Unit;\n        }\n        else if (v.buffer) {\n            if ((v.s & 2 /* Running */) !== 0) {\n                v.buffer.playbackRate.value = value / Unit;\n            }\n        }\n    }\n}\nexport var voicePool = [null];\nvar voicesMaxCount = 64;\nexport function _getVoiceObj(handle) {\n    var obj = voicePool[handle & iMask];\n    return (obj && obj.h === handle) ? obj : null;\n}\nexport function createVoiceObj() {\n    for (var i = 1; i < voicePool.length; ++i) {\n        var v = voicePool[i];\n        if (v.s === 0) {\n            return v.h;\n        }\n    }\n    var index = voicePool.length;\n    if (index < voicesMaxCount) {\n        var ctx = getContext();\n        if (ctx) {\n            var v = _voiceNew(ctx, index);\n            v.h = 805306368 /* Voice */ | index;\n            voicePool.push(v);\n            return v.h;\n        }\n    }\n    return 0;\n}\n//# sourceMappingURL=Voice.js.map","import { getAudioContextObject } from \"./Mixer\";\nimport { iMask, Unit } from \"../protocol/interface\";\nvar BusObj = /** @class */ (function () {\n    function BusObj(gain) {\n        this.gain = gain;\n        this.h = 0;\n        this.s = 1 /* Active */ | 2 /* Running */;\n        this._gain = Unit;\n    }\n    return BusObj;\n}());\nexport { BusObj };\nexport var busLine = [];\nexport function createBusObj(ctx) {\n    var next = busLine.length;\n    var obj = new BusObj(ctx.createGain());\n    obj.h = next | 268435456 /* Bus */;\n    busLine.push(obj);\n    return obj;\n}\nexport function initBusPool(ctx) {\n    var master = createBusObj(ctx).gain;\n    master.connect(ctx.destination);\n    createBusObj(ctx).gain.connect(master);\n    createBusObj(ctx).gain.connect(master);\n    createBusObj(ctx).gain.connect(master);\n}\nexport function termBusPool() {\n    for (var i = 0; i < busLine.length; ++i) {\n        busLine[i].gain.disconnect();\n    }\n    busLine.length = 0;\n}\nexport function _getBus(bus) {\n    var obj = busLine[bus & iMask];\n    return (obj && obj.h === bus) ? obj : null;\n}\nexport function _getBusGain(handle) {\n    var obj = _getBus(handle);\n    return obj ? obj.gain : undefined;\n}\nexport function _setBusConnected(bus, connected) {\n    var flag = !!(bus.s & 2 /* Running */);\n    if (flag !== connected) {\n        var master = busLine[0];\n        var dest = bus === master ? getAudioContextObject().destination : master.gain;\n        if (connected) {\n            bus.gain.connect(dest);\n        }\n        else {\n            bus.gain.disconnect(dest);\n        }\n        bus.s ^= 2 /* Running */;\n    }\n}\n//# sourceMappingURL=Bus.js.map","import { iMask } from \"../protocol/interface\";\nimport { error, log, measure } from \"./debug\";\nimport { getContext } from \"./Mixer\";\nimport { nextHandle } from \"./common\";\nvar BufferObj = /** @class */ (function () {\n    function BufferObj(index) {\n        // State Flags\n        this.s = 0;\n        this.data = null;\n        this.h = index | 536870912 /* Buffer */;\n    }\n    return BufferObj;\n}());\nexport { BufferObj };\nexport var buffers = [null];\nvar buffersMaxCount = 128;\nexport function getNextBufferObj() {\n    for (var i = 1; i < buffers.length; ++i) {\n        var buffer = buffers[i];\n        if (buffer.s === 0) {\n            return buffer.h;\n        }\n    }\n    var next = buffers.length;\n    if (next < buffersMaxCount) {\n        var b = new BufferObj(next);\n        buffers.push(b);\n        return b.h;\n    }\n    return 0;\n}\nexport function _bufferDestroy(obj) {\n    if ((obj.s & 4 /* Stream */) !== 0 && obj.data) {\n        URL.revokeObjectURL(obj.data);\n    }\n    obj.s = 0;\n    obj.h = nextHandle(obj.h);\n    obj.data = null;\n}\nexport function _getBufferObj(buffer) {\n    var obj = buffers[buffer & iMask];\n    if (obj && obj.h === buffer) {\n        return obj;\n    }\n    return null;\n}\nfunction _fetchURL(filepath, cb) {\n    return fetch(new Request(filepath)).then(cb);\n}\nexport function _bufferMemory(obj, data, flags) {\n    obj.s |= 1 /* Active */;\n    var buffer = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n    if (flags & 4 /* Stream */) {\n        obj.s |= 4 /* Stream */;\n        obj.data = URL.createObjectURL(new Blob([buffer]));\n        obj.s |= 2 /* Loaded */;\n    }\n    else {\n        var ctx = getContext();\n        if (ctx) {\n            ctx.decodeAudioData(buffer).then(function (audioBuffer) {\n                obj.data = audioBuffer;\n                obj.s |= 2 /* Loaded */;\n            }).catch(function (reason) {\n                error(\"Error decode audio buffer\", reason);\n            });\n        }\n    }\n}\nexport function _bufferLoad(obj, filepath, flags) {\n    obj.s |= 1 /* Active */;\n    if (flags & 4 /* Stream */) {\n        obj.s |= 4 /* Stream */;\n        _fetchURL(filepath, function (response) { return response.blob(); }).then(function (blob) {\n            obj.data = URL.createObjectURL(blob);\n            obj.s |= 2 /* Loaded */;\n        }).catch(function (reason) {\n            error(\"can't load audio stream data \" + filepath, reason);\n        });\n    }\n    else {\n        var timeDecoding_1 = 0;\n        _fetchURL(filepath, function (response) { return response.arrayBuffer(); }).then(function (buffer) {\n            var ctx = getContext();\n            if (ctx) {\n                timeDecoding_1 = measure(0);\n                return ctx.decodeAudioData(buffer);\n            }\n            return null;\n        }).then(function (buffer) {\n            obj.data = buffer;\n            if (buffer) {\n                log(\"decoding time: \" + (measure(timeDecoding_1) | 0) + \" ms.\");\n                obj.s |= 2 /* Loaded */;\n            }\n        }).catch(function (reason) {\n            error(\"Error decoding audio buffer\", reason);\n        });\n    }\n}\n//# sourceMappingURL=Buffer.js.map","import { _streamPlayerResume, destroyStreamPlayersPool, getNextStreamPlayer } from \"./StreamPlayer\";\nimport { _setAudioParam, audioContextPause, audioContextResume, closeContext, getAudioContextObject, getContext, getContextState, initContext } from \"./Mixer\";\nimport { _getVoiceObj, _voiceChangeDestination, _voicePrepareBuffer, _voiceSetLoop, _voiceSetPitch, _voiceSetRunning, _voiceStartBuffer, _voiceStop, createVoiceObj, voicePool } from \"./Voice\";\nimport { _getBus, _getBusGain, _setBusConnected, busLine, initBusPool, termBusPool } from \"./Bus\";\nimport { error, log, warn } from \"./debug\";\nimport { DefaultBus, iMask, Mixer, tMask, Unit } from \"../protocol/interface\";\nimport { _bufferDestroy, _bufferLoad, _bufferMemory, _getBufferObj, buffers, getNextBufferObj } from \"./Buffer\";\nexport function init() {\n    var ctx = initContext();\n    if (ctx) {\n        initBusPool(ctx);\n    }\n}\nexport function shutdown() {\n    var ctx = getContext();\n    if (ctx) {\n        termBusPool();\n        voicePool.length = 1;\n        buffers.length = 1;\n        destroyStreamPlayersPool();\n        closeContext(ctx);\n    }\n}\nexport function load(filepath, flags) {\n    var handle = getNextBufferObj();\n    if (handle) {\n        var obj = buffers[handle & iMask];\n        _bufferLoad(obj, filepath, flags);\n    }\n    return handle;\n}\nexport function loadMemory(data, flags) {\n    var handle = getNextBufferObj();\n    if (handle) {\n        var obj = buffers[handle & iMask];\n        _bufferMemory(obj, data, flags);\n    }\n    return handle;\n}\nexport function unload(name) {\n    var obj = _getBufferObj(name);\n    if (obj) {\n        stop(name);\n        _bufferDestroy(obj);\n    }\n}\n/***\n *\n * @param buffer\n * @param gain\n * @param pan\n * @param rate\n * @param flags\n * @param bus\n */\nexport function voice(buffer, gain, pan, rate, flags, bus) {\n    // arguments check debug\n    if (flags & ~(2 /* Running */ | 4 /* Loop */)) {\n        error(\"Bad flags\");\n    }\n    ///\n    var ctx = getContext();\n    if (!ctx) {\n        return 0;\n    }\n    var bufferObj = _getBufferObj(buffer);\n    if (!bufferObj) {\n        warn(14 /* BufferNotFound */);\n        return 0;\n    }\n    if (!(bufferObj.s & 2 /* Loaded */)) {\n        warn(15 /* BufferIsNotLoaded */);\n        return 0;\n    }\n    if (!bufferObj.data) {\n        warn(16 /* BufferNoData */);\n        return 0;\n    }\n    var targetNode = _getBusGain(bus ? bus : DefaultBus);\n    if (!targetNode) {\n        warn(18 /* BusNotFound */);\n        return 0;\n    }\n    var voice = createVoiceObj();\n    if (voice === 0) {\n        log(11 /* Warning_NoFreeVoices */);\n        return 0;\n    }\n    var voiceObj = _getVoiceObj(voice);\n    voiceObj.s = 1 /* Active */ | flags;\n    voiceObj.data = buffer;\n    voiceObj._rate = rate;\n    voiceObj._gain = gain;\n    voiceObj._pan = pan;\n    voiceObj.gain.gain.value = gain / Unit;\n    voiceObj.pan.pan.value = pan / Unit - 1;\n    if (bufferObj.s & 4 /* Stream */) {\n        var mes = getNextStreamPlayer(bufferObj.data);\n        if (!mes) {\n            log(12 /* Warning_NoFreeStreamPlayers */);\n            return 0;\n        }\n        voiceObj.stream = mes;\n        mes.el.loop = !!(flags & 4 /* Loop */);\n        mes.node.connect(voiceObj.pan);\n        mes.el.onended = voiceObj._e;\n        if (flags & 2 /* Running */) {\n            _streamPlayerResume(mes);\n        }\n    }\n    else {\n        _voicePrepareBuffer(voiceObj, ctx, bufferObj.data);\n        if (flags & 2 /* Running */) {\n            _voiceStartBuffer(voiceObj);\n        }\n    }\n    // maybe we need to set target before `startBuffer()`\n    _voiceChangeDestination(voiceObj, targetNode);\n    _voiceSetPitch(voiceObj, rate);\n    return voice;\n}\nexport function stop(name) {\n    if (name === 0) {\n        return;\n    }\n    var type = name & tMask;\n    if (type === 805306368 /* Voice */) {\n        var obj = _getVoiceObj(name);\n        if (obj) {\n            _voiceStop(obj);\n        }\n    }\n    else if (type === 536870912 /* Buffer */) {\n        var obj = _getBufferObj(name);\n        if (obj) {\n            for (var i = 1; i < voicePool.length; ++i) {\n                var v = voicePool[i];\n                if (v.data === name) {\n                    _voiceStop(v);\n                }\n            }\n        }\n        else {\n            warn(14 /* BufferNotFound */);\n        }\n    }\n}\nexport function set(name, param, value) {\n    if (name === 0) {\n        return;\n    }\n    if (name === Mixer && (param & 128 /* Flags */) && (param & 2 /* Running */)) {\n        var ctx = getContext();\n        if (ctx) {\n            if (value && ctx.state === \"suspended\") {\n                audioContextResume(ctx);\n            }\n            else if (!value && ctx.state === \"running\") {\n                audioContextPause(ctx);\n            }\n        }\n    }\n    var type = name & tMask;\n    if (type === 805306368 /* Voice */) {\n        var obj = _getVoiceObj(name);\n        if (obj) {\n            if (param & 128 /* Flags */) {\n                var enabled = value !== 0;\n                if (param & 2 /* Running */) {\n                    _voiceSetRunning(obj, enabled);\n                }\n                else if (param & 4 /* Loop */) {\n                    _voiceSetLoop(obj, enabled);\n                }\n            }\n            else {\n                switch (param) {\n                    case 1 /* Gain */:\n                        if (obj._gain !== value) {\n                            obj._gain = value;\n                            _setAudioParam(obj.gain.gain, value / Unit);\n                        }\n                        break;\n                    case 2 /* Pan */:\n                        if (obj._pan !== value) {\n                            obj._pan = value;\n                            _setAudioParam(obj.pan.pan, value / Unit - 1);\n                        }\n                        break;\n                    case 3 /* Rate */:\n                        _voiceSetPitch(obj, value);\n                        break;\n                    case 4 /* CurrentTime */:\n                        // TODO:\n                        break;\n                    default:\n                        break;\n                }\n            }\n        }\n    }\n    else if (type === 268435456 /* Bus */) {\n        var obj = _getBus(name);\n        if (obj) {\n            if (param & 128 /* Flags */) {\n                if (param & 2 /* Running */) {\n                    _setBusConnected(obj, !!value);\n                }\n            }\n            else {\n                switch (param) {\n                    case 1 /* Gain */:\n                        if (obj._gain !== value) {\n                            _setAudioParam(obj.gain.gain, value / Unit);\n                        }\n                        break;\n                    default:\n                        break;\n                }\n            }\n        }\n    }\n}\nexport function get(name, param) {\n    if (name === Mixer) {\n        var ctx = getAudioContextObject();\n        if (ctx) {\n            if (param === 0 /* State */) {\n                return getContextState(ctx);\n            }\n            else if (param === 5 /* SampleRate */) {\n                return ctx.sampleRate | 0;\n            }\n        }\n        return 0;\n    }\n    var type = name & tMask;\n    if ((param & 256 /* Count */) && !(name & iMask)) {\n        var stateMask = param & 127 /* StateMask */;\n        if (type === 805306368 /* Voice */) {\n            return _countObjectsWithFlags(voicePool, stateMask);\n        }\n        else if (type === 268435456 /* Bus */) {\n            return _countObjectsWithFlags(busLine, stateMask);\n        }\n        else if (type === 536870912 /* Buffer */) {\n            return _countObjectsWithFlags(buffers, stateMask);\n        }\n        return 0;\n    }\n    if (type === 805306368 /* Voice */) {\n        var obj = _getVoiceObj(name);\n        if (obj) {\n            switch (param) {\n                case 0 /* State */:\n                    return obj.s;\n                case 1 /* Gain */:\n                    return obj._gain;\n                case 2 /* Pan */:\n                    return obj._pan;\n                case 3 /* Rate */:\n                    return obj._rate;\n                case 6 /* Duration */: {\n                    var d = 0.0;\n                    if (obj.buffer && obj.buffer.buffer) {\n                        d = obj.buffer.buffer.duration * Unit;\n                    }\n                    else if (obj.stream) {\n                        d = obj.stream.el.duration * Unit;\n                    }\n                    return (d * Unit) | 0;\n                }\n                case 4 /* CurrentTime */: {\n                    var d = 0.0;\n                    if (obj.buffer && obj.buffer.buffer) {\n                        // TODO: :(\n                    }\n                    else if (obj.stream) {\n                        d = obj.stream.el.currentTime;\n                    }\n                    return (d * Unit) | 0;\n                }\n                default:\n                    warn(0 /* NotSupported */);\n                    break;\n            }\n        }\n        return 0;\n    }\n    else if (type === 268435456 /* Bus */) {\n        var obj = _getBus(name);\n        if (obj) {\n            switch (param) {\n                case 0 /* State */:\n                    return obj.s;\n                case 1 /* Gain */:\n                    return obj._gain;\n                default:\n                    warn(0 /* NotSupported */);\n                    break;\n            }\n        }\n        return 0;\n    }\n    else if (type === 536870912 /* Buffer */) {\n        var obj = _getBufferObj(name);\n        if (obj) {\n            switch (param) {\n                case 0 /* State */:\n                    return obj.s;\n                case 6 /* Duration */: {\n                    var d = 0.0;\n                    if (obj.s & 4 /* Stream */) {\n                        // TODO: :(\n                        warn(0 /* NotSupported */);\n                    }\n                    else if (obj.data) {\n                        d = obj.data.duration;\n                    }\n                    return (d * Unit) | 0;\n                }\n                default:\n                    warn(0 /* NotSupported */);\n                    break;\n            }\n        }\n        return 0;\n    }\n    return 0;\n}\n/** private helpers **/\nfunction _countObjectsWithFlags(arr, mask) {\n    var cnt = 0;\n    for (var i = 1; i < arr.length; ++i) {\n        var obj = arr[i];\n        if (obj && (obj.s & mask) === mask) {\n            ++cnt;\n        }\n    }\n    return cnt;\n}\n//# sourceMappingURL=index.js.map","import { Mixer, Unit } from \"./protocol/interface\";\nimport * as Null from \"./null/index\";\nimport * as Browser from \"./webaudio/index\";\nfunction loadDriver() {\n    if (typeof process !== \"undefined\") {\n        //return require(__dirname + \"/../../../nodejs/index\");\n        return require(\"bindings\")(\"auph\");\n    }\n    else if (typeof auwa !== \"undefined\") {\n        return auwa;\n    }\n    else if (typeof AudioContext !== \"undefined\") {\n        //  || typeof webkitAudioContext !== \"undefined\"\n        window.auwa = Browser;\n        return Browser;\n    }\n    return Null;\n}\nvar _ = loadDriver();\nexport * from \"./protocol/static\";\nexport var init = _.init;\nexport var shutdown = _.shutdown;\nexport var set = _.set;\nexport var get = _.get;\nexport var load = _.load;\nexport var loadMemory = _.loadMemory;\nexport var unload = _.unload;\nexport var stop = _.stop;\nexport function pause(name) {\n    if (name === void 0) { name = Mixer; }\n    setPause(name, true);\n}\nexport function resume(name) {\n    if (name === void 0) { name = Mixer; }\n    setPause(name, false);\n}\nexport function play(buffer, gain, pan, rate, loop, paused, bus) {\n    if (gain === void 0) { gain = 1.0; }\n    if (pan === void 0) { pan = 0.0; }\n    if (rate === void 0) { rate = 1.0; }\n    var flags = 0;\n    if (!!loop)\n        flags |= 4 /* Loop */;\n    if (!paused)\n        flags |= 2 /* Running */;\n    return _.voice(buffer, f2u(gain), f2u(+pan + 1), f2u(rate), flags, 0 | bus);\n}\nexport function getMixerStateString(state) {\n    return [\"closed\", \"paused\", \"\", \"running\"][state & 3];\n}\nexport function getBufferStateString(state) {\n    return [\"free\", \"loading\", \"\", \"loaded\"][state & 0x3] + [\"\", \" streaming\"][(state >>> 2) & 0x1];\n}\nexport function setGain(busOrVoice, value) {\n    set(busOrVoice, 1 /* Gain */, f2u(value));\n}\nexport function getGain(busOrVoice) {\n    return get(busOrVoice, 1 /* Gain */) / Unit;\n}\nexport function setPan(voice, pan) {\n    set(voice, 2 /* Pan */, f2u(+pan + 1));\n}\nexport function setRate(voice, rate) {\n    set(voice, 3 /* Rate */, f2u(rate));\n}\nexport function setPause(name, value) {\n    set(name, 128 /* Flags */ | 2 /* Running */, 0 | !value);\n}\nexport function setLoop(voice, value) {\n    set(voice, 128 /* Flags */ | 4 /* Loop */, 0 | value);\n}\nexport function getPan(voice) {\n    return get(voice, 2 /* Pan */) / Unit - 1;\n}\nexport function getRate(voice) {\n    return get(voice, 3 /* Rate */) / Unit;\n}\nexport function getPause(voice) {\n    return !(get(voice, 0 /* State */) & 2 /* Running */);\n}\nexport function getLoop(voice) {\n    return !!(get(voice, 0 /* State */) & 4 /* Loop */);\n}\nexport function getCurrentTime(voice) {\n    return get(voice, 4 /* CurrentTime */) / Unit;\n}\nexport function isActive(name) {\n    return !!(get(name, 0 /* State */) & 1 /* Active */);\n}\nexport function getDuration(name) {\n    return get(name, 6 /* Duration */) / Unit;\n}\nfunction f2u(x) {\n    return (x * Unit) | 0;\n}\n//# sourceMappingURL=index.js.map","import { Mixer } from \"./interface\";\n/** Export Constants only for pre-bundled usage **/\nexport var SAMPLE_RATE = 5 /* SampleRate */;\nexport var STATE = 0 /* State */;\nexport var COUNT = 256 /* Count */;\nexport var ACTIVE = 1 /* Active */;\nexport var RUNNING = 2 /* Running */;\nexport var STREAM = 4 /* Stream */;\nexport var LOOP = 4 /* Loop */;\nexport var MIXER = Mixer;\nexport var BUS = 268435456 /* Bus */;\nexport var VOICE = 805306368 /* Voice */;\nexport var BUFFER = 536870912 /* Buffer */;\nexport var BUS_MASTER = 268435456 /* Bus */ | 0;\nexport var BUS_SFX = 268435456 /* Bus */ | 1;\nexport var BUS_MUSIC = 268435456 /* Bus */ | 2;\nexport var BUS_SPEECH = 268435456 /* Bus */ | 3;\n//# sourceMappingURL=static.js.map"],"names":["tMask","iMask","Unit","filepath","flags","data","name","buffer","gain","pan","rate","bus","param","value","TAG","warn","message","console","error","reason","ctx","unlockEvents","unlocked","getContext","state","getAudioContextObject","audioContextResume","resume","then","catch","addEventListener","document","i","length","unlock","setupUnlockHandler","audioContextPause","suspend","removeEventListener","initContext","options","scope","window","AudioContext","webkitAudioContext","latencyHint","sampleRate","_a","newAudioContext","closeContext","_notNullCtx","close","_setAudioParam","emptyWaveData","StreamPlayer","el","node","this","StreamPlayer_isFree","player","src","StreamPlayer_stop","onended","pause","currentTime","disconnect","_streamPlayerResume","play","players","getNextStreamPlayer","mes","url","Audio","preload","createMediaElementSource","StreamPlayer_create","push","nextHandle","h","VoiceObj","index","_this","s","_gain","_pan","_rate","stream","_started","target","_e","_voiceStop","v","stop","_voiceResetDestination","_voiceStartBuffer","source","loop","start","_voiceSetPitch","playbackRate","voicePool","_getVoiceObj","handle","obj","createVoiceObj","createGain","createStereoPanner","connect","_voiceNew","BusObj","busLine","createBusObj","next","_getBus","BufferObj","buffers","getNextBufferObj","b","_getBufferObj","_fetchURL","cb","fetch","Request","type","_countObjectsWithFlags","arr","mask","cnt","master","destination","initBusPool","termBusPool","destroyStreamPlayersPool","response","blob","URL","createObjectURL","arrayBuffer","decodeAudioData","_bufferLoad","slice","byteOffset","byteLength","Blob","audioBuffer","_bufferMemory","revokeObjectURL","_bufferDestroy","bufferObj","targetNode","undefined","voice","voiceObj","createBufferSource","_voicePrepareBuffer","_voiceChangeDestination","enabled","_voiceSetRunning","_voiceSetLoop","connected","dest","_setBusConnected","getContextState","stateMask","d","duration","_","process","require","auwa","Browser","Null","init","shutdown","set","get","load","loadMemory","unload","setPause","f2u","x","busOrVoice","paused"],"mappings":"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"}