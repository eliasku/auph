var auph=function(n){"use strict";var t=805306368,e=255,r=1024;var a=Object.freeze({__proto__:null,init:function(){},shutdown:function(){},load:function(n,t){return 0},unload:function(n){},voice:function(n,t,e,r,a,u){return 0},stop:function(n){},set:function(n,t,e){},get:function(n,t){return 0}}),u="[AUPH]";function i(n){console.warn(u,n)}function o(n,t){console.error(u,n,t)}var f=null,c=["mousedown","pointerdown","touchstart"],s=!1;function l(){return f?"closed"===f.state?(o("invalid state:","Context is closed"),null):f:(i("not initialized"),null)}function d(){return f}function v(n){n.resume().then((function(){})).catch((function(n){s?o("error resuming AudioContext",n):function(){for(var n=document.addEventListener,t=0;t<c.length;++t)n(c[t],g)}()}))}function h(n){n.suspend().then((function(){})).catch((function(n){o("error suspending AudioContext",n)}))}function g(){s=!0;for(var n=document.removeEventListener,t=0;t<c.length;++t)n(c[t],g);f&&"suspended"===f.state&&v(f)}function p(){return f?(i("already initialized"),f):(f=new AudioContext({latencyHint:"interactive",sampleRate:22050}))?("running"===f.state&&h(f),f.baseLatency,f.sampleRate,f):(o("error create AudioContext"),null)}function b(n){n.close().then((function(){})).catch((function(n){o("shutdown error",n)})),f=null}function _(n,t){n.value!==t&&(n.value=t)}var A="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAVFYAAFRWAAABAAgAZGF0YQAAAAA=",m=function(n,t){this.el=n,this.node=t};function w(n){return n.el.src===A}function R(n){var t=n.el;t.src!==A&&(t.pause(),t.src=A,t.currentTime=0,n.node.disconnect())}function S(n){n.el.play().then((function(){})).catch((function(n){o("error on play stream",n)}))}var y=[];function E(n){for(var t=0;t<y.length;++t){var e=y[t];if(w(e))return e.el.src=n,e}if(y.length<4){var r=l();if(r){var a=function(n,t){var e=new Audio(t);return e.preload="metadata",e.preservesPitch=!1,new m(e,n.createMediaElementSource(e))}(r,n);return y.push(a),a}}return null}function U(n){return n+256&16776960|805306623&n}var B=function(n,t,e){var a=this;this.gain=n,this.pan=t,this.h=0,this.s=0,this._gain=r,this._pan=r,this._rate=r,this.data=0,this.bus=0,this.stream=null,this._started=!1,this.buffer=null,this.target=null,this._e=function(n){a.buffer===n.target&&C(a)},this.h=805306368|e};function C(n){n.stream&&(R(n.stream),n.stream=null);var t=n.buffer;t&&(0!=(2&n.s)&&t.stop(),t.disconnect(),n.buffer=null),function(n){n.target&&(n.gain.disconnect(n.target),n.target=null)}(n),n.data=0,n.bus=0,n.s=0,n.h=U(n.h)}function L(n){var t=n.buffer;t&&!n._started&&(t.onended=n._e,t.loop=0!=(4&n.s),t.start(),n._started=!0)}function P(n,t){n._rate!==t&&(n._rate=t,n.stream?n.stream.el.playbackRate=t/r:n.buffer&&0!=(2&n.s)&&(n.buffer.playbackRate.value=t/r))}var T=[null];function O(n){var t=T[n&e];return t&&t.h===n?t:null}function x(){for(var n=1;n<T.length;++n){if(0===(e=T[n]).s)return e.h}var t=T.length;if(t<64){var e,r=l();if(r)return(e=function(n,t){var e=n.createGain(),r=n.createStereoPanner();return r.connect(e),new B(e,r,t)}(r,t)).h=805306368|t,T.push(e),e.h}return 0}var M=function(n){this.gain=n,this.h=0,this.s=3,this._gain=r},j=[];function k(n){var t=j.length,e=new M(n.createGain());return e.h=268435456|t,j.push(e),e}function F(n){var t=j[n&e];return t&&t.h===n?t:null}var G=function(n){this.s=0,this.data=null,this.h=536870912|n},I=[null];function z(n){var t=I[n&e];return t&&t.h===n?t:null}function N(n,t){return fetch(new Request(n)).then(t)}function V(n){if(0!==n){var e=n&t;if(805306368===e)(r=O(n))&&C(r);else if(536870912===e){var r;if(r=z(n))for(var a=1;a<T.length;++a){var u=T[a];u.data===n&&C(u)}else i("invalid buffer reference")}}}function H(n,t){for(var e=0,r=1;r<n.length;++r){var a=n[r];a&&(a.s&t)===t&&++e}return e}var Q=Object.freeze({__proto__:null,init:function(){var n=p();n&&function(n){var t=k(n).gain;t.connect(n.destination),k(n).gain.connect(t),k(n).gain.connect(t),k(n).gain.connect(t)}(n)},shutdown:function(){var n=l();n&&(!function(){for(var n=0;n<j.length;++n)j[n].gain.disconnect();j.length=0}(),T.length=1,I.length=1,function(){for(var n=0;n<y.length;++n){var t=y[n];R(t),t.el.src=""}y.length=0}(),b(n))},load:function(n,t){var r=function(){for(var n=1;n<I.length;++n){var t=I[n];if(0===t.s)return t.h}var e=I.length;if(e<128){var r=new G(e);return I.push(r),r.h}return 0}();return r&&function(n,t,e){n.s|=1,4&e?(n.s|=4,N(t,(function(n){return n.blob()})).then((function(t){n.data=URL.createObjectURL(t),n.s|=2})).catch((function(n){o("can't load audio stream data "+t,n)}))):N(t,(function(n){return n.arrayBuffer()})).then((function(n){var t=l();return t?t.decodeAudioData(n):null})).then((function(t){n.data=t,t&&(n.s|=2)})).catch((function(n){o("can't load audio buffer from "+t,n)}))}(I[r&e],n,t),r},unload:function(n){var t=z(n);t&&(V(n),function(n){0!=(4&n.s)&&n.data&&URL.revokeObjectURL(n.data),n.s=0,n.h=U(n.h),n.data=null}(t))},voice:function(n,t,e,a,u,f){-7&u&&o("Bad flags");var c=l();if(!c)return 0;var s=z(n);if(!s)return i("audio source not found"),0;if(!(2&s.s))return i("audio source is not loaded yet"),0;if(!s.data)return i("nothing to play, no audio data"),0;var d,v=(d=F(f||268435457))?d.gain:void 0;if(!v)return i("invalid target bus!"),0;var h=x();if(0===h)return 0;var g=O(h);if(g.s=1|u,g.data=n,g._rate=a,g._gain=t,g._pan=e,g.gain.gain.value=t/r,g.pan.pan.value=e/r-1,4&s.s){var p=E(s.data);if(!p)return 0;g.stream=p,p.el.loop=!!(4&u),p.node.connect(g.pan),2&u&&S(p)}else!function(n,t,e){var r=t.createBufferSource();r.buffer=e,r.connect(n.pan),n.buffer=r,n._started=!1}(g,c,s.data),2&u&&L(g);return function(n,t){if(t!==n.target){var e=n.gain;n.target&&e.disconnect(n.target),n.target=t,t&&e.connect(t)}}(g,v),P(g,a),h},stop:V,set:function(n,e,a){if(0!==n){if(1===n&&128&e&&2&e){var u=l();u&&(a&&"suspended"===u.state?v(u):a||"running"!==u.state||h(u))}var i=n&t;if(805306368===i){if(f=O(n))if(128&e){var o=0!==a;2&e?function(n,t){t!==!!(2&n.s)&&(n.s^=2,n.stream?t?S(n.stream):n.stream.el.pause():n.buffer&&(n.buffer.playbackRate.value=t?n._rate/r:0,t&&L(n)))}(f,o):4&e&&function(n,t){t!==(0!=(4&n.s))&&(n.s^=4,n.stream?n.stream.el.loop=t:n.buffer&&(n.buffer.loop=t))}(f,o)}else switch(e){case 1:f._gain!==a&&(f._gain=a,_(f.gain.gain,a/r));break;case 2:f._pan!==a&&(f._pan=a,_(f.pan.pan,a/r-1));break;case 3:P(f,a)}}else if(268435456===i){var f;if(f=F(n))if(128&e)2&e&&function(n,t){if(!!(2&n.s)!==t){var e=j[0],r=n===e?d().destination:e.gain;t?n.gain.connect(r):n.gain.disconnect(r),n.s^=2}}(f,!!a);else switch(e){case 1:f._gain!==a&&_(f.gain.gain,a/r)}}}},get:function(n,a){if(1===n){var u=d();if(u){if(0===a)return function(n){var t=0;return"closed"!==n.state&&(t|=1,"running"===n.state&&(t|=2)),t}(u);if(5===a)return 0|u.sampleRate}return 0}var o=n&t;if(256&a&&!(n&e)){var f=127&a;return 805306368===o?H(T,f):268435456===o?H(j,f):536870912===o?H(I,f):0}if(805306368===o){if(s=O(n))switch(a){case 0:return s.s;case 1:return s._gain;case 2:return s._pan;case 3:return s._rate;case 6:var c=0;return s.buffer&&s.buffer.buffer?c=s.buffer.buffer.duration*r:s.stream&&(c=s.stream.el.duration*r),c*r|0;case 4:c=0;return s.buffer&&s.buffer.buffer||s.stream&&(c=s.stream.el.currentTime),c*r|0;default:i("not supported")}return 0}if(268435456===o){if(s=F(n))switch(a){case 0:return s.s;case 1:return s._gain;default:i("not supported")}return 0}if(536870912===o){var s;if(s=z(n))switch(a){case 0:return s.s;case 6:c=0;return 4&s.s?i("not supported"):s.data&&(c=s.data.duration),c*r|0;default:i("param not supported")}return 0}return 0}});var X="undefined"!=typeof process?require("auph/nodejs/index.js"):"undefined"!=typeof auwa?auwa:"undefined"!=typeof AudioContext?(window.auwa=Q,Q):a,Z=X.init,q=X.shutdown,D=X.set,Y=X.get,W=X.load,J=X.unload,K=X.stop;function $(n,t){D(n,130,0|!t)}function nn(n){return n*r|0}return n.ACTIVE=1,n.BUFFER=536870912,n.BUS=268435456,n.BUS_MASTER=268435456,n.BUS_MUSIC=268435458,n.BUS_SFX=268435457,n.BUS_SPEECH=268435459,n.COUNT=256,n.LOOP=4,n.MIXER=1,n.RUNNING=2,n.SAMPLE_RATE=5,n.STATE=0,n.STREAM=4,n.VOICE=805306368,n.get=Y,n.getBufferStateString=function(n){return["free","loading","","loaded"][3&n]+[""," streaming"][n>>>2&1]},n.getCurrentTime=function(n){return Y(n,4)/r},n.getDuration=function(n){return Y(n,6)/r},n.getGain=function(n){return Y(n,1)/r},n.getLoop=function(n){return!!(4&Y(n,0))},n.getMixerStateString=function(n){return["closed","paused","","running"][3&n]},n.getPan=function(n){return Y(n,2)/r-1},n.getPause=function(n){return!(2&Y(n,0))},n.getRate=function(n){return Y(n,3)/r},n.init=Z,n.isActive=function(n){return!!(1&Y(n,0))},n.load=W,n.pause=function(n){void 0===n&&(n=1),$(n,!0)},n.play=function(n,t,e,r,a,u,i){void 0===t&&(t=1),void 0===e&&(e=0),void 0===r&&(r=1);var o=0;return a&&(o|=4),u||(o|=2),X.voice(n,nn(t),nn(+e+1),nn(r),o,0|i)},n.resume=function(n){void 0===n&&(n=1),$(n,!1)},n.set=D,n.setGain=function(n,t){D(n,1,nn(t))},n.setLoop=function(n,t){D(n,132,0|t)},n.setPan=function(n,t){D(n,2,nn(+t+1))},n.setPause=$,n.setRate=function(n,t){D(n,3,nn(t))},n.shutdown=q,n.stop=K,n.unload=J,Object.defineProperty(n,"__esModule",{value:!0}),n}({});//# sourceMappingURL=auph.js.map
