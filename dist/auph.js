var Auph=function(n){"use strict";var t="[AUPH]";function e(n){console.warn(t,n)}function r(n,e){console.error(t,n,e)}var a=null,u=["mousedown","pointerdown","touchstart"],i=!1;function o(){return a?"closed"===a.state?(r("invalid state:","Context is closed"),null):a:(e("not initialized"),null)}function c(){var n=0;return a&&("suspended"===a.state?n=2:"running"===a.state&&(n=1)),n}function f(n){n.resume().then((function(){})).catch((function(n){i?r("error resuming AudioContext",n):function(){for(var n=document.addEventListener,t=0;t<u.length;++t)n(u[t],s)}()}))}function s(){i=!0;for(var n=document.removeEventListener,t=0;t<u.length;++t)n(u[t],s);a&&"suspended"===a.state&&f(a)}function l(){return a?(e("already initialized"),a):(a=new AudioContext({latencyHint:"interactive",sampleRate:22050}))?("running"===a.state&&function(n){n.suspend().then((function(){})).catch((function(n){r("error suspending AudioContext",n)}))}(a),a.baseLatency,a.sampleRate,a):(r("error create AudioContext"),null)}function v(n){n.close().then((function(){})).catch((function(n){r("shutdown error",n)})),a=null}var d="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAVFYAAFRWAAABAAgAZGF0YQAAAAA=",g=function(n,t){this.el=n,this.node=t};function h(n){return n.el.src===d}function p(n){var t=n.el;t.src!==d&&(t.pause(),t.src=d,t.currentTime=0,n.node.disconnect())}function A(n){n.el.play().then((function(){})).catch((function(n){r("error on play stream",n)}))}var m=[];function b(n){for(var t=0;t<m.length;++t){var e=m[t];if(h(e))return e.el.src=n,e}if(m.length<4){var r=o();if(r){var a=function(n,t){var e=new Audio(t);return e.preload="metadata",e.preservesPitch=!1,new g(e,n.createMediaElementSource(e))}(r,n);return m.push(a),a}}return null}var S=16776960,E=function(n,t){var e=this;this.gain=n,this.pan=t,this.stream=null,this.buffer=null,this.rate=1,this.cf=0,this.target=null,this.data=0,this.v=0,this._e=function(n){e.buffer===n.target&&R(e)}};function R(n){n.stream&&(p(n.stream),n.stream=null);var t=n.buffer;t&&(0!=(1&n.cf)&&t.stop(),t.disconnect(),n.buffer=null),function(n){n.target&&(n.gain.disconnect(n.target),n.target=null)}(n),n.data=0,n.cf=0,n.v=n.v+256&S}function _(n){if(0==(1&n.cf)){var t=n.buffer;t&&(t.onended=n._e,t.loop=0!=(4&n.cf),t.start(),n.cf|=1)}}function w(n,t){n.rate!==t&&(n.rate=t,n.stream?n.stream.el.playbackRate=t:n.buffer&&(2&n.cf||(n.buffer.playbackRate.value=t)))}var B=[null];function y(n){var t=B[255&n];return t&&t.v===(n&S)?t:null}function L(){for(var n=1;n<B.length;++n){var t=B[n];if(0===t.data)return n|t.v}var e=B.length;if(e<64){var r=o();if(r)return B.push(function(n){var t=n.createGain(),e=n.createStereoPanner();return e.connect(t),new E(t,e)}(r)),e}return 0}var U=function(){this.cf=0,this.data=null},V=[null];var P=function(n,t){void 0===t&&(t=!0),this.gain=n,this.e=t},C=[];function D(n){var t=new P(n.createGain());return C.push(t),t}function I(n){return C[n]}function T(n){var t=I(n);return t?t.gain:void 0}function F(n,t){return fetch(new Request(n)).then(t)}function M(n){if(0!==n)for(var t=1;t<B.length;++t){var e=B[t];e.data===n&&R(e)}else console.warn("invalid source")}return n.BUFFERS_LOADED=2,n.BUS_MASTER=0,n.BUS_MUSIC=2,n.BUS_SFX=1,n.BUS_SPEECH=2,n.DEVICE_SAMPLE_RATE=4,n.DEVICE_STATE=5,n.STREAMS_IN_USE=1,n.STREAMS_LOADED=3,n.VOICES_IN_USE=0,n._getAudioContext=function(){return o()},n.getAudioDataState=function(n){if(0!==n){var t=V[n];if(t)return t.cf}return 0},n.getAudioDataStateString=function(n){var t;return null!==(t=["invalid","loading","-","loaded"][3&n])&&void 0!==t?t:"undefined"},n.getAudioSourceLength=function(n){var t=0;if(0!==n){var e=V[n];e&&e.data&&(4&e.cf||(t=e.data.duration))}return t},n.getBusEnabled=function(n){var t=I(n);return!!t&&t.e},n.getBusVolume=function(n){var t=T(n);return t?t.gain.value:0},n.getDeviceStateString=function(n){var t;return null!==(t=["invalid","running","paused"][n])&&void 0!==t?t:"undefined"},n.getInteger=function(n){switch(n){case 0:for(var t=0,e=1;e<B.length;++e)B[e].buffer&&++t;return t;case 1:return function(){for(var n=0,t=0;t<m.length;++t)h(m[t])||++n;return n}();case 2:case 3:return 0;case 4:var r=o();return r?r.sampleRate:0;case 5:return c()}return 0},n.getLoop=function(n){var t=y(n);return!!t&&0!=(4&t.cf)},n.getPan=function(n){var t=y(n);return t?t.pan.pan.value:0},n.getPause=function(n){var t=y(n);return!!t&&0!=(2&t.cf)},n.getPitch=function(n){var t=y(n);return t?t.rate:1},n.getVoiceLength=function(n){var t=y(n),e=0;return t&&(t.buffer&&t.buffer.buffer?e=t.buffer.buffer.duration:t.stream&&(e=t.stream.el.duration)),e},n.getVoicePosition=function(n){var t=y(n),e=0;return t&&(t.buffer&&t.buffer||t.stream&&(e=t.stream.el.currentTime)),e},n.getVoiceState=function(n){var t=y(n);return t?t.cf:0},n.getVolume=function(n){var t=y(n);return t?t.gain.gain.value:1},n.init=function(){var n=l();n&&function(n){var t=D(n).gain;t.connect(n.destination),D(n).gain.connect(t),D(n).gain.connect(t),D(n).gain.connect(t)}(n)},n.isVoiceValid=function(n){return!!(e=B[255&(t=n)])&&e.v===(t&S);var t,e},n.load=function(n,t){var e=function(){for(var n=1;n<V.length;++n)if(0===V[n].cf)return n;var t=V.length;return t<128?(V.push(new U),t):0}();if(0===e)return 0;var a=V[e];return a.cf|=1,t?(a.cf|=4,F(n,(function(n){return n.blob()})).then((function(n){a.data=URL.createObjectURL(n),a.cf|=2})).catch((function(t){r("can't load audio stream data "+n,t)}))):F(n,(function(n){return n.arrayBuffer()})).then((function(n){var t=o();return t?t.decodeAudioData(n):null})).then((function(n){a.data=n,n&&(a.cf|=2)})).catch((function(t){r("can't load audio buffer from "+n,t)})),e},n.pause=function(){var n=o();n&&"running"===n.state&&n.suspend().then((function(){})).catch((function(n){r("pause error",n)}))},n.play=function(n,t,r,a,u,i,c){if(void 0===t&&(t=1),void 0===r&&(r=0),void 0===a&&(a=1),void 0===u&&(u=!1),void 0===i&&(i=!1),void 0===c&&(c=1),0===n)return 0;var f=o();if(!f)return 0;var s=V[n];if(!s)return e("audio source not found"),0;if(0==(2&s.cf))return e("audio source is not loaded yet"),0;if(null===s.data)return e("nothing to play, no audio data"),0;var l=T(c);if(!l)return e("invalid target bus!"),0;var v=L();if(!v)return 0;var d=y(v);if(i&&(d.cf|=4),u&&(d.cf|=2),d.rate=1,d.data=n,d.gain.gain.value=t,d.pan.pan.value=r,4&s.cf){var g=b(s.data);if(!g)return 0;d.stream=g,g.el.loop=i,g.node.connect(d.pan),u||(A(g),d.cf|=1)}else!function(n,t,e){var r=t.createBufferSource();r.buffer=e,r.connect(n.pan),n.buffer=r}(d,f,s.data),u||_(d);return function(n,t){if(t!==n.target){var e=n.gain;n.target&&e.disconnect(n.target),n.target=t,t&&e.connect(t)}}(d,l),w(d,a),v},n.resume=function(){var n=o();n&&"suspended"===n.state&&f(n)},n.setBusEnabled=function(n,t){var e=I(n);e&&function(n,t){if(n.e!==t){var e=C[0],r=n===e?o().destination:e.gain;t?n.gain.connect(r):n.gain.disconnect(r),n.e=t}}(e,t)},n.setBusVolume=function(n,t){var e=T(n);e&&(e.gain.value=t)},n.setLoop=function(n,t){var e=y(n);e&&function(n,t){t!==(0!=(4&n.cf))&&(n.cf^=4,n.stream?n.stream.el.loop=t:n.buffer&&(n.buffer.loop=t))}(e,t)},n.setPan=function(n,t){var e=y(n);e&&(e.pan.pan.value=t)},n.setPause=function(n,t){var e=y(n);e&&function(n,t){t!==(0!=(2&n.cf))&&(n.cf^=2,t?n.stream?n.stream.el.pause():n.buffer&&(n.buffer.playbackRate.value=0):n.stream?A(n.stream):n.buffer&&(n.buffer.playbackRate.value=n.rate,_(n)))}(e,t)},n.setPitch=function(n,t){var e=y(n);e&&w(e,t)},n.setVolume=function(n,t){var e=y(n);e&&(e.gain.gain.value=t)},n.shutdown=function(){var n=o();n&&(!function(){for(var n=0;n<C.length;++n)C[n].gain.disconnect();C.length=0}(),B.length=1,V.length=1,function(){for(var n=0;n<m.length;++n){var t=m[n];p(t),t.el.src=""}m.length=0}(),v(n))},n.stop=function(n){var t=y(n);t&&R(t)},n.stopAudioData=M,n.unload=function(n){if(0!==n){M(n);var t=V[n];t&&(0!=(4&t.cf)&&t.data&&URL.revokeObjectURL(t.data),t.cf=0,t.data=null)}},Object.defineProperty(n,"__esModule",{value:!0}),n}({});//# sourceMappingURL=auph.js.map
